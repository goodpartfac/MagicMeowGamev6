<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Magic Meow Run - ‡∏Ñ‡∏£‡∏π‡∏Ç‡∏±‡∏ô‡∏ó‡∏≠‡∏á</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;800&family=Mali:wght@700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background: #ffebee; font-family: 'Mali', cursive; touch-action: none; }
        canvas { display: block; width: 100%; height: 100%; }

        /* Class ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏´‡∏°‡∏∏‡∏ô‡∏à‡∏≠ */
        .forced-rot {
            transform: rotate(90deg);
            transform-origin: top left;
            position: absolute;
            top: 0;
            left: 100%;
            width: 100vh !important;
            height: 100vw !important;
            overflow: hidden;
            z-index: 0;
        }

        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(255, 255, 255, 0.95); z-index: 10;
        }
        .active { display: flex; }

        #click-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            color: white; flex-direction: column; cursor: pointer;
        }
        .pulse-text { 
            animation: pulse 1.5s infinite; 
            font-size: 5vmin; 
            font-weight: bold; font-family: 'Kanit'; -webkit-text-stroke: 1px black; text-align: center;
        }
        
        #rotate-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ff4081; z-index: 10000;
            display: none; align-items: center; justify-content: center;
            color: white; flex-direction: column; text-align: center;
        }
        
        .skip-btn {
            margin-top: 20px;
            padding: 2vmin 4vmin;
            background: white;
            color: #ff4081;
            border: 3px solid white;
            border-radius: 50px;
            font-size: 3vmin; 
            font-weight: bold;
            font-family: 'Kanit', sans-serif;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* Panel (‡πÉ‡∏ä‡πâ vmin ‡πÉ‡∏´‡πâ‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏∏‡∏Å‡∏à‡∏≠) */
        .panel {
            background: #fff; 
            padding: 2vmin;
            border-radius: 3vmin;
            border: 1vmin solid #ff4081; 
            box-shadow: 0 0 0 0.5vmin #fff inset, 0 10px 20px rgba(0,0,0,0.3);
            text-align: center; 
            width: 80%; 
            max-width: 600px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        h1 { color: #ff007f; font-size: 8vmin; margin: 0; text-shadow: 2px 2px 0 #fff; font-family: 'Kanit', sans-serif; -webkit-text-stroke: 1px #ad1457; line-height: 1.2; }
        h3 { color: #555; margin: 0.5vmin 0; font-size: 4vmin; font-weight: bold; }
        
        .logo-img { height: 15vmin; filter: drop-shadow(3px 3px 5px rgba(0,0,0,0.3)); margin-bottom: 1vmin; }

        .btn {
            display: block; width: 90%; 
            padding: 1.5vmin 0;
            margin: 1vmin auto;
            font-size: 4vmin; 
            color: white; border: none; border-radius: 50px;
            cursor: pointer; font-family: 'Kanit', sans-serif; font-weight: bold;
            border: 0.5vmin solid #fff; box-shadow: 0 0.8vmin 0 rgba(0,0,0,0.2);
            transition: transform 0.1s; text-shadow: 1px 1px 0 rgba(0,0,0,0.3);
        }
        .btn:active { transform: translateY(3px); box-shadow: none; }
        .btn-green { background: linear-gradient(#66bb6a, #43a047); }
        .btn-orange { background: linear-gradient(#ffa726, #fb8c00); }
        .btn-red { background: linear-gradient(#ef5350, #e53935); }

        #hud {
            position: absolute; top: 0; left: 0; width: 100%; height: 15vmin;
            pointer-events: none; display: flex; justify-content: space-between; padding: 2vmin; box-sizing: border-box;
        }
        #mission-panel {
            background: rgba(255,255,255,0.95); border: 0.5vmin solid #ffb74d; border-radius: 3vmin;
            padding: 0 3vmin; display: flex; gap: 2vmin; align-items: center; height: 10vmin;
            box-shadow: 0 0.5vmin 1.5vmin rgba(0,0,0,0.2);
        }
        .hud-text { 
            font-size: 5vmin; color: #fff; text-shadow: 2px 2px 0 #000; font-weight: 900; font-family: 'Kanit', sans-serif;
            background: rgba(0,0,0,0.4); padding: 0.5vmin 2vmin; border-radius: 2vmin; border: 0.3vmin solid #fff;
        }
        
        #time-container {
            position: absolute; top: 12vmin; right: 2vmin; width: 30vw; height: 3vmin;
            background: #fff; border: 0.3vmin solid #333; border-radius: 1vmin; overflow: hidden;
        }
        #time-bar { width: 100%; height: 100%; background: linear-gradient(to right, #ffeb3b, #ff1744); transition: width 0.2s linear; }

        .stats-box {
            display: flex; justify-content: space-around; width: 100%;
            background: #fff; border-radius: 2vmin; padding: 1vmin; margin: 1vmin 0;
            border: 0.5vmin solid #81d4fa;
        }
        .stat-item { font-size: 4.5vmin; font-weight: 900; }

    </style>
</head>
<body>

<div style="display:none;">
    <img id="spritesheet" src="spritesheet.png">
    <img id="bg-main" src="bg_main.jpg">
    <img id="bg-game" src="bg_game.jpg">
    <img id="logo" src="logo.png" onerror="this.style.display='none'">
    
    <img id="star1" src="star1.png"> <img id="star2" src="star2.png"> <img id="star3" src="star3.png">
    <img id="bubble1" src="bubble1.png"> <img id="bubble2" src="bubble2.png"> <img id="bubble3" src="bubble3.png">
    <img id="gate1" src="gate1.png"> <img id="gate2" src="gate2.png"> <img id="gate3" src="gate3.png">
    <img id="boom" src="boom.png">
</div>

<div id="rotate-overlay">
    <div style="font-size: 10vmin;">üîÑ</div>
    <h1 style="color:white; -webkit-text-stroke:0; font-size: 8vmin;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏´‡∏°‡∏∏‡∏ô‡∏à‡∏≠</h1>
    <h3 style="color:white; font-size: 4vmin;">‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡∏Ñ‡∏£‡∏±‡∏ö</h3>
    <button class="skip-btn" onclick="forceEnterGame()">‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏•‡∏¢ (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏´‡∏°‡∏∏‡∏ô)</button>
    <p style="color:white; font-size:3vmin; margin-top:2vmin;">(‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡∏´‡∏≤‡∏Å‡∏´‡∏°‡∏∏‡∏ô‡∏à‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô)</p>
</div>

<div id="click-overlay" onclick="unlockAudio()">
    <div class="pulse-text">üëÜ ‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</div>
    <div style="font-size: 4vmin; margin-top: 2vmin; color: #ffeb3b;">(‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á)</div>
</div>

<div id="screen-start" class="screen active">
    <div style="position:absolute; width:100%; height:100%; z-index:-1; background: url('bg_main.jpg') center/cover;"></div>
    <div class="panel">
        <img src="logo.png" class="logo-img">
        <h1>Magic Meow Run</h1>
        <h3>‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ß‡∏±‡∏í‡∏ô‡∏≤</h3>
        <h3 style="color: #f06292; font-size: 3.5vmin;">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô: ‡∏Ñ‡∏£‡∏π‡∏Ç‡∏±‡∏ô‡∏ó‡∏≠‡∏á ‡πÇ‡∏û‡∏ò‡∏¥‡πå‡πÄ‡∏ï‡∏µ‡πâ‡∏¢</h3>
        <hr style="border: 0.2vmin dashed #ff8a80; margin: 1.5vmin 0; width: 100%;">
        <button class="btn btn-green" onclick="selectLevel(1)">‚≠ê ‡∏î‡πà‡∏≤‡∏ô 1: ‡∏á‡πà‡∏≤‡∏¢</button>
        <button class="btn btn-orange" onclick="selectLevel(2)">‚≠ê‚≠ê ‡∏î‡πà‡∏≤‡∏ô 2: ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</button>
        <button class="btn btn-red" onclick="selectLevel(3)">‚≠ê‚≠ê‚≠ê ‡∏î‡πà‡∏≤‡∏ô 3: ‡πÄ‡∏£‡πá‡∏ß!</button>
    </div>
</div>

<div id="screen-mission" class="screen">
    <div class="panel" style="border-color: #29b6f6; background: #e1f5fe;">
        <h1 style="color: #0277bd; -webkit-text-stroke: 0px;">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏î‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ</h1>
        <div id="mission-list-display" style="margin: 2vmin; text-align: left; font-size: 5vmin; color: #01579b; font-weight: bold;"></div>
        <button class="btn btn-green" style="background: linear-gradient(#42a5f5, #1976d2);" onclick="startGame()">‚ñ∂ ‡∏û‡∏£‡πâ‡∏≠‡∏°...‡∏•‡∏∏‡∏¢!</button>
    </div>
</div>

<canvas id="gameCanvas"></canvas>
<div id="hud" style="display:none;">
    <div class="hud-text">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô <span id="score">0</span></div>
    <div id="mission-panel"></div>
    <div class="hud-text">‚è∞ <span id="time">60</span></div>
</div>
<div id="time-container" style="display:none;"><div id="time-bar"></div></div>

<div id="screen-end" class="screen">
    <div class="panel">
        <h1 id="end-title" style="-webkit-text-stroke: 2px black; font-size: 10vmin;">‡∏à‡∏ö‡πÄ‡∏Å‡∏°!</h1>
        <div style="background:#fff; border-radius:3vmin; padding:2vmin; margin:2vmin; box-shadow: 0 10px 25px rgba(0,0,0,0.2); border: 0.5vmin solid #ffd54f; width: 80%;">
             <p style="color:#555; font-size:4vmin; margin:0; font-weight: bold;">‚≠ê ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° ‚≠ê</p>
             <h1 id="final-score" style="color: #00c853; font-size: 12vmin; margin:0; line-height:1; -webkit-text-stroke: 3px black;">0</h1>
        </div>
        <div class="stats-box">
            <div class="stat-item" style="color: #4caf50;">
                ‚úÖ ‡∏ñ‡∏π‡∏Å: <span id="stat-correct">0</span>
            </div>
            <div class="stat-item" style="color: #f44336;">
                ‚ùå ‡∏ú‡∏¥‡∏î: <span id="stat-wrong">0</span>
            </div>
        </div>
        <button class="btn btn-green" style="background: linear-gradient(#ab47bc, #8e24aa);" onclick="location.reload()">üîÑ ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
    </div>
</div>

<audio id="bgm" src="bgm.mp3" loop volume="0.3"></audio>
<audio id="sfx-jump" src="jump.mp3"></audio>
<audio id="sfx-collect" src="collect.mp3"></audio>
<audio id="sfx-win" src="win.mp3"></audio>
<audio id="sfx-lose" src="lose.mp3"></audio>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const spriteSheet = document.getElementById('spritesheet');
    const bgGame = document.getElementById('bg-game');

    const ASSETS = {
        STAR:   [document.getElementById('star1'), document.getElementById('star2'), document.getElementById('star3')],
        BUBBLE: [document.getElementById('bubble1'), document.getElementById('bubble2'), document.getElementById('bubble3')],
        GATE:   [document.getElementById('gate1'), document.getElementById('gate2'), document.getElementById('gate3')],
        BOOM:   document.getElementById('boom')
    };

    const CAT_FRAMES = { STAND: {c:0, r:0}, RUN: {c:1, r:0}, JUMP: {c:2, r:0} };

    let gameState = { 
        playing: false, score: 0, time: 60, maxTime: 60, speed: 5, missions: [], isEnding: false,
        statCorrect: 0, statWrong: 0
    };

    let scaleRatio = 1;
    let player = { x: 50, y: 0, w: 280, h: 280, dy: 0, grounded: false, state: 'STAND' }; 
    let items = [];
    let groundY = 150; 
    let spawnTimer = 0;
    let frameCount = 0;
    
    let isForcedRotated = false;

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏∏‡∏ô‡∏à‡∏≠ ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏´‡∏°‡∏∏‡∏ô ---
    function checkOrientation() {
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏´‡∏° (‡∏Å‡∏ß‡πâ‡∏≤‡∏á > ‡∏™‡∏π‡∏á)
        if (window.innerWidth > window.innerHeight) {
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏´‡∏°‡∏∏‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            if (isForcedRotated) {
                document.body.classList.remove('forced-rot');
                isForcedRotated = false;
                resize(); // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            }
            document.getElementById('rotate-overlay').style.display = 'none';
        } else {
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á
            if (isForcedRotated) {
                // ‡∏ñ‡πâ‡∏≤‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏´‡∏°‡∏∏‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏ä‡∏ß‡πå overlay ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                document.getElementById('rotate-overlay').style.display = 'none';
            } else {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏´‡∏°‡∏∏‡∏ô ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå overlay ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                document.getElementById('rotate-overlay').style.display = 'flex';
            }
        }
    }
    
    function forceEnterGame() {
        if (window.innerWidth < window.innerHeight) {
            document.body.classList.add('forced-rot');
            isForcedRotated = true;
        }
        document.getElementById('rotate-overlay').style.display = 'none';
        resize(); 
    }

    function resize() {
        // ‡∏ñ‡πâ‡∏≤‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡∏à‡∏£‡∏¥‡∏á ‡πÉ‡∏´‡πâ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏´‡∏°‡∏∏‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
        if (window.innerWidth > window.innerHeight && isForcedRotated) {
            document.body.classList.remove('forced-rot');
            isForcedRotated = false;
        }

        let w, h;
        if (isForcedRotated) {
            w = window.innerHeight;
            h = window.innerWidth;
        } else {
            w = window.innerWidth;
            h = window.innerHeight;
        }

        canvas.width = w;
        canvas.height = h;
        
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
        checkOrientation();

        scaleRatio = h / 720; 
        
        player.w = 280 * scaleRatio;
        player.h = 280 * scaleRatio;
        groundY = 180 * scaleRatio;
        
        if(player.grounded) player.y = h - groundY - player.h;
    }
    
    window.addEventListener('resize', resize);
    window.addEventListener('load', resize);
    
    // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢‡πÜ ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡∏´‡∏°‡∏∏‡∏ô‡πÅ‡∏•‡πâ‡∏ß Event ‡πÑ‡∏°‡πà‡πÄ‡∏î‡πâ‡∏á
    setInterval(checkOrientation, 500);

    function speak(text) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel(); 
            let u = new SpeechSynthesisUtterance(text);
            u.lang = 'th-TH'; u.rate = 1.0; u.volume = 1.0; 
            window.speechSynthesis.speak(u);
        }
    }

    function unlockAudio() {
        document.getElementById('click-overlay').style.display = 'none';
        speak("‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö");
    }

    function selectLevel(lvl) {
        gameState.level = lvl;
        if(lvl==1) { gameState.speed = 5 * scaleRatio; gameState.time = 60; }
        if(lvl==2) { gameState.speed = 8 * scaleRatio; gameState.time = 50; }
        if(lvl==3) { gameState.speed = 11 * scaleRatio; gameState.time = 45; }
        gameState.maxTime = gameState.time;
        generateMissions(lvl);
        showScreen('screen-mission');
        speak("‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Ñ‡∏£‡∏±‡∏ö"); 
        document.getElementById('bgm').play().catch(()=>{});
    }

    function generateMissions(lvl) {
        gameState.missions = [];
        const types = [
            {key:'STAR', name:'‡∏î‡∏≤‡∏ß'}, {key:'BUBBLE', name:'‡∏ß‡∏á‡∏Å‡∏•‡∏°'}, {key:'GATE', name:'‡∏õ‡∏£‡∏∞‡∏ï‡∏π'}
        ];
        let count = (lvl===1) ? 2 : 3;
        for(let i=0; i<count; i++) {
            let req = 2 + Math.floor(Math.random() * 3);
            gameState.missions.push({...types[i], required: req, current: 0});
        }
        let html = '';
        gameState.missions.forEach(m => {
            html += `<div style="padding:1vh;">üî∏ ‡∏´‡∏≤ <b>${m.name}</b> : <span style="color:#e91e63; font-weight:900; font-size:6vmin;">${m.required}</span> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>`;
        });
        document.getElementById('mission-list-display').innerHTML = html;
    }

    function startGame() {
        showScreen(null);
        document.getElementById('hud').style.display = 'flex';
        document.getElementById('time-container').style.display = 'block';
        gameState.playing = true;
        gameState.isEnding = false;
        gameState.score = 0;
        gameState.statCorrect = 0;
        gameState.statWrong = 0;
        items = [];
        player.y = canvas.height - groundY - player.h;
        speak("‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏Ñ‡∏£‡∏±‡∏ö");
        updateHUD();
        gameLoop();
        let timer = setInterval(() => {
            if(!gameState.playing || gameState.isEnding) { clearInterval(timer); return; }
            gameState.time--;
            updateTimeBar();
            if(gameState.time <= 0) endGame(false);
        }, 1000);
    }

    function update() {
        if(!gameState.playing) return;
        frameCount++;
        let gravity = 0.7 * scaleRatio;
        
        if(!player.grounded) { player.dy += gravity; player.y += player.dy; }
        if(player.y + player.h > canvas.height - groundY) {
            player.y = canvas.height - groundY - player.h;
            player.dy = 0; player.grounded = true;
        }
        player.state = (!player.grounded) ? 'JUMP' : (Math.floor(frameCount/10)%2==0 ? 'STAND' : 'RUN');

        spawnTimer++;
        let rate = 110 - (gameState.level * 20); 
        if(spawnTimer > rate) { spawnItem(); spawnTimer = 0; }

        for(let i=0; i<items.length; i++) {
            let it = items[i];
            it.x -= gameState.speed;
            
            let padX = 60 * scaleRatio; 
            let padY = 20 * scaleRatio; 

            if(!it.collected && !gameState.isEnding &&
               player.x + padX < it.x + it.w - padX && 
               player.x + player.w - padX > it.x + padX &&
               player.y + padY < it.y + it.h - padY && 
               player.y + player.h - padY > it.y + padY) {
               collectItem(it);
            }
            if(it.x + it.w < 0) { items.splice(i,1); i--; }
        }
    }

    function spawnItem() {
        const keys = ['STAR', 'BUBBLE', 'GATE'];
        let key = keys[Math.floor(Math.random() * keys.length)];
        
        let isTopRow = Math.random() > 0.5;
        let itemSize = 130 * scaleRatio; 
        
        let posY;
        if(isTopRow) {
            posY = canvas.height - groundY - player.h - itemSize - (10 * scaleRatio); 
        } else {
            posY = canvas.height - groundY - itemSize + (20 * scaleRatio); 
        }

        let subIndex = Math.floor(Math.random() * 3);

        items.push({ 
            x: canvas.width, 
            y: posY, 
            w: itemSize, 
            h: itemSize, 
            type: key, 
            subIndex: subIndex, 
            collected: false 
        });
    }

    function collectItem(it) {
        it.collected = true;
        let originalType = it.type;
        it.type = 'BOOM'; 
        setTimeout(() => { items = items.filter(x => x!==it); }, 300);

        let mission = gameState.missions.find(m => m.key === originalType);
        if(mission && mission.current < mission.required) {
            mission.current++;
            gameState.score += 100;
            gameState.statCorrect++; 
            document.getElementById('sfx-collect').play();
            speak(mission.name + " " + mission.current); 
        } else {
            gameState.score += 10;
            gameState.statWrong++; 
            document.getElementById('sfx-collect').play();
        }
        updateHUD();
        if(!gameState.isEnding && gameState.missions.every(m => m.current >= m.required)) {
             gameState.isEnding = true;
             speak("‡πÄ‡∏¢‡πâ ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö");
             setTimeout(() => endGame(true), 3000); 
        }
    }

    function updateHUD() {
        document.getElementById('score').innerText = gameState.score;
        let p = document.getElementById('mission-panel');
        p.innerHTML = '';
        gameState.missions.forEach(m => {
            let color = (m.current >= m.required) ? '#4caf50' : '#0277bd';
            let check = (m.current >= m.required) ? '‚úÖ' : '';
            let iconId = m.key.toLowerCase() + '1'; 
            let imgSrc = document.getElementById(iconId).src;

            p.innerHTML += `
                <div style="text-align:center;">
                    <img src="${imgSrc}" style="height:8vmin; vertical-align:middle;">
                    <div style="font-size:5vmin; color:${color}; font-weight:900; -webkit-text-stroke: 1px black;">${m.current}/${m.required}${check}</div>
                </div>
            `;
        });
    }

    function endGame(win) {
        gameState.playing = false;
        showScreen('screen-end');
        document.getElementById('hud').style.display = 'none';
        document.getElementById('time-container').style.display = 'none';
        
        document.getElementById('final-score').innerText = gameState.score;
        document.getElementById('stat-correct').innerText = gameState.statCorrect;
        document.getElementById('stat-wrong').innerText = gameState.statWrong;
        
        let t = document.getElementById('end-title');
        if(win) {
            t.innerText = "‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!!"; t.style.color="#4caf50"; t.style.webkitTextStroke="2px #388e3c";
            document.getElementById('sfx-win').play();
            speak("‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö");
        } else {
            t.innerText = "‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡πâ‡∏≤"; t.style.color="#f44336"; t.style.webkitTextStroke="2px #d32f2f";
            document.getElementById('sfx-lose').play();
            speak("‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö");
        }
    }

    function draw() {
        if(bgGame.complete) ctx.drawImage(bgGame, 0, 0, canvas.width, canvas.height);
        else { ctx.fillStyle='#b3e5fc'; ctx.fillRect(0,0,canvas.width,canvas.height); }

        items.forEach(it => {
            if(it.type === 'BOOM') {
                ctx.drawImage(ASSETS.BOOM, it.x, it.y, it.w, it.h);
            } else {
                let img = ASSETS[it.type][it.subIndex];
                if(img && img.complete) {
                    ctx.drawImage(img, it.x, it.y, it.w, it.h);
                }
            }
        });

        drawCat(player.state, player.x, player.y, player.w, player.h);
    }

    function drawCat(key, x, y, w, h) {
        let f = CAT_FRAMES[key]; if(!f) return;
        let sw = spriteSheet.naturalWidth/4;
        let sh = spriteSheet.naturalHeight/2;
        let sx = f.c * sw;
        let sy = f.r * sh;
        ctx.drawImage(spriteSheet, sx, sy, sw, sh, x, y, w, h);
    }

    function gameLoop() { if(gameState.playing){ update(); draw(); requestAnimationFrame(gameLoop); } }
    function showScreen(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); if(id) document.getElementById(id).classList.add('active'); }
    function updateTimeBar() { document.getElementById('time-bar').style.width = (gameState.time/gameState.maxTime*100)+'%'; document.getElementById('time').innerText=gameState.time; }
    
    function jump() { 
        if(player.grounded && gameState.playing) { 
            player.dy = -19 * scaleRatio; 
            player.grounded=false; 
            document.getElementById('sfx-jump').play(); 
        } 
    }
    window.addEventListener('mousedown', jump);
    window.addEventListener('touchstart', e=>{
        jump();
    });
    window.addEventListener('keydown', e=>{if(e.code=='Space') jump();});

</script>
</body>
</html>